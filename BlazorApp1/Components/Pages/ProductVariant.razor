@rendermode InteractiveServer

<style>
    .variant-container {
        border: 1px solid#eeedeb;
        border-radius: 8px;
        padding: 12px;
    }
    .notes {
        font-size: small;
    }
    .main-variant {
        display: flex;
    }
    .main-variant-btn {
        padding: 8px 12px;
        background-color: #eeedeb;
        border-radius: 16px;
        margin: 10px;
        cursor: pointer;
        min-width: 80px;
        text-align: center;
    }
    .main-variant-btn-selected {
        background-color: #c2f3a9;
    }
    .main-variant-header {
        display: flex;
        justify-content: space-between;
    }
    .add-btn {
        color: green;
        cursor: pointer;
    }

    .fade-box {
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        height: 0;
        overflow: hidden;
    }

    .fade-box.show {
        opacity: 1;
        transform: translateY(0);
        height: auto;
    }

    .fade-box.hide {
        opacity: 0;
        transform: translateY(-10px);
        height: 0;
    }

    .subvariant-container-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .subvariant-container {
        position: relative;
        display: inline-block;
    }

    .subvariant-content {
        max-width: 120px;
        max-height: 120px;
        border-radius: 16px;
    }
    .subvariant-remove {
        position: absolute;
        top: 2px;
        right: 2px;
        background: red;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 50%;
    }

    .variantlist-container-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .variantlist-container {
        position: relative;
        display: inline-block;
    }

    .variantlist-content {
        max-width: 120px;
        max-height: 120px;
        border-radius: 16px;
    }
    .variantlist-remove {
        position: absolute;
        top: 2px;
        right: 2px;
        background: red;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 50%;
    }

</style>

<div class="mb-3 form-check">
    <input class="form-check-input" type="checkbox" id="createVariantCB" @bind="isChecked"/>
    <label class="form-check-label" for="createVariantCB">Create variant</label>
</div>

<div class="@($"fade-box {(isChecked ? "show" : "hide")}")" >
    <div>Variant Type</div>
    <p class="notes">Choose maximum 2 variant type</p>

    <div class="mb-3 variantlist-container-container">
        @foreach (var i in VariantType)
        {
            <div class="variantlist-container">
                <div class="@($"variantlist-content main-variant-btn {(i.IsSelected ? "main-variant-btn-selected" : "")}")" @onclick="() => SelectVariant(i)">@i.Name</div>
                <span class="variantlist-remove" @onclick="() => RemoveVariant(i)">x</span>
            </div>
        }
    </div>

    @if (IsExceedTwoVariant)
    {
        <div>Maximum 2 variants can be selected</div>
    }

    <div class="main-variant-header mb-3">
        <div class="add-btn" @onclick="ToggleCreateVariantType">Create variant type</div>
    </div>

    <div class="mb-3 p-3 border" hidden="@(toggleCreateVariantType == false ? "hidden" : null)">
        <input class="form-control mb-3" placeholder="Variant type name"
            @bind=variantName @bind:event="oninput"
            @onkeydown="HandleEnterKey" />

        <div class="btn btn-primary" @onclick="AddCreateVariantType">Add</div>
    </div>

    @foreach (var i in selectedVariant)
    {
        <div class="main-variant-header">
            <div>@i.Name</div>
            <div class="add-btn" @onclick="() => ToggleSubVariant(i)">Add</div>
        </div>

        <div class="subvariant-container-container">
            @foreach (var j in i.SubVariantTypeNames)
            {
                <div class="subvariant-container">
                    <div class="subvariant-content main-variant-btn main-variant-btn-selected">@j.Name</div>
                    <span class="subvariant-remove" @onclick="() => RemoveSubVariant(i, j)">x</span>
                </div>
            }
        </div>

        <div class="mb-3 p-3 border" hidden="@(i.ShowSubVariant ? null : "hidden")">
            <input class="form-control mb-3" placeholder="Variant color name" 
                @bind=subVariantName @bind:event="oninput"
                @onkeydown="(e) => HandleEnterKeyAddSubVariant(e, i)" />
            <div class="btn btn-primary" @onclick="() => AddSubVariant(i)">Add</div>
        </div>

    }

    <div class="main-variant-header">
        <div>Manage variant</div>
        <div class="add-btn" @onclick="ToggleManageVariant">Add</div>
    </div>

    @if (toggleManageVariant)
    {
        <div class="variant-container">
            @foreach (var i in ManageVariants)
            {
                <div class="main-variant-header mb-3">
                    @if (!string.IsNullOrEmpty(i.SecondVariantId))
                    {
                        <div>@i.FirstVariantName - @i.SecondVariantName</div>
                    }
                    else
                    {
                        <div>@i.FirstVariantName</div>
                    }
                    <div>
                        <input type="checkbox"
                            checked="@i.IsMainProduct"
                            @onchange="(e) => HandleInputSetAsMainProductManageVariant(i, e)" />

                        <label>Set as main product</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Price</label>
                    <input class="form-control" @oninput="(e) => HandleInputPriceManageVariant(i, e.Value?.ToString())"/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Stock</label>
                    <input class="form-control" @oninput="(e) => HandleInputStockManageVariant(i, e.Value?.ToString())"/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Weight</label>
                    <input class="form-control" @oninput="(e) => HandleInputWeightManageVariant(i, e.Value?.ToString())"/>
                </div>
            }
        </div>
    }
</div>

@code {
    @* protected override async Task OnInitializedAsync()
    {

    } *@

    public class VariantTypeName
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string? Name { get; set; }
        public bool ShowSubVariant { get; set; } = false;
        public bool IsSelected { get; set; } = false;
        public List<SubVariantTypeName> SubVariantTypeNames { get; set; } = new();
    }

    public class SubVariantTypeName
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string? Name { get; set; }
        public VariantTypeName variantTypeName { get; set; } = new();
    }

    private bool isChecked = false;
    private bool toggleCreateVariantType = false;
    private void ToggleCreateVariantType()
    {
        toggleCreateVariantType = !toggleCreateVariantType;
    }
    private string? variantName { get; set; }
    private List<VariantTypeName> VariantType { get; set; } = new() 
    {
        new VariantTypeName() { Name = "Color", Id = "1" }, 
        new VariantTypeName() { Name = "Size", Id = "2" } 
    };

    private void HandleEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddCreateVariantType();
        }
    }

    private void AddCreateVariantType()
    {
        if (!string.IsNullOrEmpty(variantName))
        {
            VariantType.Add(new VariantTypeName() { Name = variantName, Id = Guid.NewGuid().ToString() });
            variantName = null;
            ToggleCreateVariantType();
        }
    }

    private void HandleEnterKeyAddSubVariant(KeyboardEventArgs e, VariantTypeName variant)
    {
        if (e.Key == "Enter")
        {
            AddSubVariant(variant);
        }
    }

    private string? subVariantName { get; set;}

    private void AddSubVariant(VariantTypeName variant)
    {
        if (!string.IsNullOrEmpty(subVariantName))
        {
            var temp = VariantType.Where(i => i.Id == variant.Id).FirstOrDefault();
            var subVariant = new SubVariantTypeName { Name = subVariantName, Id = Guid.NewGuid().ToString() };
            temp?.SubVariantTypeNames.Add(subVariant);
            subVariantName = null;
            ToggleSubVariant(variant);
            CalculateManageVariant();
        }
    }

    private void ToggleSubVariant(VariantTypeName variant)
    {
        variant.ShowSubVariant = !variant.ShowSubVariant;
    }

    private bool toggleManageVariant { get; set; }
    private void ToggleManageVariant(MouseEventArgs args)
    {
        toggleManageVariant = !toggleManageVariant;
        CalculateManageVariant();
    }

    public class ManageVariant
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string? FirstVariantId { get; set; }
        public string? FirstVariantName { get; set; }
        public string? SecondVariantId { get; set; }
        public string? SecondVariantName { get; set; }
        public string? Price { get; set; }
        public string? Stock { get; set; }
        public string? Weight { get; set; }
        public bool IsMainProduct { get; set; }
    }

    private List<ManageVariant> ManageVariants { get; set; } = new();

    private void CalculateManageVariant()
    {
        List<ManageVariant> res = new();

        if (selectedVariant.Count == 0)
        {
            ManageVariants = res;
            return;
        }

        var firstVariant = selectedVariant[0];

        if (selectedVariant.Count == 1 || selectedVariant[1].IsSelected == false || selectedVariant[1].SubVariantTypeNames.Count == 0)
        {
            // If only one variant is selected, create entries using only that variant
            foreach (var subVariant in firstVariant.SubVariantTypeNames)
            {
                var temp = new ManageVariant()
                {
                    FirstVariantId = subVariant.Id,
                    FirstVariantName = subVariant.Name,
                    SecondVariantId = null,  // No second variant
                    SecondVariantName = null,
                    Price = null,
                    Stock = null,
                    Weight = null,
                    IsMainProduct = false
                };

                res.Add(temp);
            }
        }
        else if (selectedVariant.Count > 1)
        {
            // Handle two variants as before
            var secondVariant = selectedVariant[1];

            foreach (var color in firstVariant.SubVariantTypeNames)
            {
                foreach (var size in secondVariant.SubVariantTypeNames)
                {
                    var temp = new ManageVariant()
                    {
                        FirstVariantId = color.Id,
                        FirstVariantName = color.Name,
                        SecondVariantId = size.Id,
                        SecondVariantName = size.Name,
                        Price = null,
                        Stock = null,
                        Weight = null,
                        IsMainProduct = false
                    };

                    res.Add(temp);
                }
            }
        }

        ManageVariants = res;
    }


    private List<VariantTypeName> selectedVariant { get; set; } = new();
    private bool IsExceedTwoVariant = false;
    private void SelectVariant(VariantTypeName? selectedVariantParam)
    {
        if (selectedVariantParam == null || selectedVariantParam.Name == string.Empty) return;

        var temp = selectedVariant.Where(i => i.Id == selectedVariantParam.Id).FirstOrDefault();
        if (temp != null)
        {
            selectedVariantParam.IsSelected = false;
            IsExceedTwoVariant = false;
            selectedVariant.Remove(temp);
        }
        else 
        {
            if (selectedVariant.Count < 2)
            {
                selectedVariantParam.IsSelected = true; 
                selectedVariant.Add(selectedVariantParam);
                IsExceedTwoVariant = false;
            }
            else 
            {
                selectedVariantParam.IsSelected = false;
                selectedVariant.Remove(selectedVariantParam);
                IsExceedTwoVariant = true;
            }
        }
        CalculateManageVariant();
    }
    private void RemoveSubVariant(VariantTypeName variant, SubVariantTypeName subVariant)
    {
        variant.SubVariantTypeNames.Remove(subVariant);
        CalculateManageVariant();
    }

    private void RemoveVariant(VariantTypeName variant)
    {
        VariantType.Remove(variant);
        selectedVariant.Remove(variant);
        CalculateManageVariant();
    }

    private void HandleInputPriceManageVariant(ManageVariant manage, string? value)
    {
        var temp = ManageVariants.FirstOrDefault(i => i.Id == manage.Id);
        if (temp == null) return;
        temp.Price = value;
    }

    private void HandleInputStockManageVariant(ManageVariant manage, string? value)
    {
        var temp = ManageVariants.FirstOrDefault(i => i.Id == manage.Id);
        if (temp == null) return;
        temp.Stock = value;
    }

    private void HandleInputWeightManageVariant(ManageVariant manage, string? value)
    {
        var temp = ManageVariants.FirstOrDefault(i => i.Id == manage.Id);
        if (temp == null) return;
        temp.Weight = value;
    }

    private void HandleInputSetAsMainProductManageVariant(ManageVariant manage, ChangeEventArgs e)
    {
        bool isChecked = e.Value is bool value && value;

        foreach (var item in ManageVariants)
        {
            item.IsMainProduct = false;
        }

        manage.IsMainProduct = isChecked;
    }

}

@* todo: edit variant *@
@* todo: tampil di list table *@

@* todo: pindahkan manage variant kedalam class untuk menyimpan valuenya: DONE*@
@* todo: manage variant bisa handle satu subvariant dari satu variant: DONE *@
@* todo: set main product hanya 1: DONE *@
